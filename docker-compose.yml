version: "3.9"

services:
  # üêá RabbitMQ broker
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: rabbitmq
    ports:
      - "5672:5672"   # Puerto para comunicaci√≥n con apps
      - "15672:15672" # Consola web (http://localhost:15672)
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: pass
    networks:
      - app-net

  # üêò Base de datos para order-service
  order-db:
    image: postgres:16
    container_name: order-db
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: ordersdb
      POSTGRES_USER: orders_user
      POSTGRES_PASSWORD: orders_pass
    networks:
      - app-net

  # üêò Base de datos para inventory-service
  inventory-db:
    image: postgres:16
    container_name: inventory-db
    ports:
      - "5434:5432"
    environment:
      POSTGRES_DB: inventoryesdb
      POSTGRES_USER: notif_user
      POSTGRES_PASSWORD: notif_pass
    networks:
      - app-net

  # üêò Base de datos para payment-service
  payment-db:
    image: postgres:16
    container_name: payment-db
    ports:
      - "5435:5432"
    environment:
      POSTGRES_DB: paymentsdb
      POSTGRES_USER: payment_user
      POSTGRES_PASSWORD: payment_pass
    networks:
      - app-net

  # üöÄ Microservicio 1: order-service
  order-service:
    build: ./order-service
    container_name: order-service
    ports:
      - "8081:8080"
    depends_on:
      - rabbitmq
      - order-db
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: user
      SPRING_RABBITMQ_PASSWORD: pass

      SPRING_DATASOURCE_URL: jdbc:postgresql://order-db:5432/ordersdb
      SPRING_DATASOURCE_USERNAME: orders_user
      SPRING_DATASOURCE_PASSWORD: orders_pass
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.PostgreSQLDialect
    networks:
      - app-net

  # üöÄ Microservicio 2: inventory-service
  inventory-service:
    build: ./inventory-service
    container_name: inventory-service
    ports:
      - "8082:8080"
    depends_on:
      - rabbitmq
      - inventory-db
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: user
      SPRING_RABBITMQ_PASSWORD: pass

      SPRING_DATASOURCE_URL: jdbc:postgresql://inventory-db:5432/inventoryesdb
      SPRING_DATASOURCE_USERNAME: notif_user
      SPRING_DATASOURCE_PASSWORD: notif_pass
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.PostgreSQLDialect
    networks:
      - app-net

  # üöÄ Microservicio 3: payment-service
  payment-service:
    build: ./payment-service
    container_name: payment-service
    ports:
      - "8083:8080"
    depends_on:
      - rabbitmq
      - payment-db
    environment:
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: user
      SPRING_RABBITMQ_PASSWORD: pass

      SPRING_DATASOURCE_URL: jdbc:postgresql://payment-db:5432/paymentsdb
      SPRING_DATASOURCE_USERNAME: payment_user
      SPRING_DATASOURCE_PASSWORD: payment_pass
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_DATABASE_PLATFORM: org.hibernate.dialect.PostgreSQLDialect
    networks:
      - app-net

networks:
  app-net:
    driver: bridge
